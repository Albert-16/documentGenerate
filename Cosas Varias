using System.IO;
using MigraDoc.DocumentObjectModel;
using MigraDoc.DocumentObjectModel.Tables;

public static void AgregarBloqueFirmasDobleSeguro(
    Section section,
    string rutaImagenFirmaBanco,
    double separacionCm = 1.0,          // separación entre ambas firmas
    double altoContenidoCm = 2.0,        // altura disponible para imagen/texto sobre la línea
    double anchoImagenMaxCm = 4.5,       // ancho máximo permitido para la imagen
    double anchoBloqueTotalCm = 0        // 0 = usa todo el ancho útil
)
{
    if (section == null) throw new ArgumentNullException(nameof(section));

    // Ancho útil de la página
    Unit anchoUtil = section.PageSetup.PageWidth - section.PageSetup.LeftMargin - section.PageSetup.RightMargin;

    // Ancho del bloque de firmas (centrado)
    Unit anchoBloque = anchoBloqueTotalCm > 0 ? Unit.FromCentimeter(anchoBloqueTotalCm) : anchoUtil;

    // Usamos 3 columnas: IZQ | ESPACIADOR | DER
    Unit colEspacio = Unit.FromCentimeter(separacionCm);
    if (colEspacio > anchoBloque) colEspacio = anchoBloque / 10; // salvaguarda
    Unit colFirma = (anchoBloque - colEspacio) / 2;

    var tabla = section.AddTable();
    tabla.Borders.Width = 0;
    tabla.LeftPadding = 0; tabla.RightPadding = 0; tabla.TopPadding = 0; tabla.BottomPadding = 0;
    tabla.Format.SpaceBefore = Unit.FromCentimeter(0.4);
    tabla.Format.SpaceAfter  = Unit.FromCentimeter(0.4);
    tabla.Format.Alignment   = ParagraphAlignment.Center;

    tabla.AddColumn(colFirma);
    tabla.AddColumn(colEspacio);
    tabla.AddColumn(colFirma);

    // Centrar tabla dentro del ancho útil
    tabla.Rows.LeftIndent = (anchoUtil - anchoBloque) / 2;

    // ================= Fila 1: contenido sobre la línea =================
    var filaContenido = tabla.AddRow();
    filaContenido.HeightRule = RowHeightRule.Exactly;
    filaContenido.Height = Unit.FromCentimeter(altoContenidoCm);
    filaContenido.VerticalAlignment = VerticalAlignment.Bottom;

    // --- IZQ: imagen firma banco (con ajuste de tamaño para que SIEMPRE se vea) ---
    var pImg = filaContenido.Cells[0].AddParagraph();
    pImg.Format.Alignment = ParagraphAlignment.Center;

    if (!string.IsNullOrWhiteSpace(rutaImagenFirmaBanco) && File.Exists(rutaImagenFirmaBanco))
    {
        var img = pImg.AddImage(rutaImagenFirmaBanco);
        img.LockAspectRatio = true;

        // Limitar por ALTO para que no se corte.
        var altoMax = Unit.FromCentimeter(altoContenidoCm - 0.2);  // pequeño margen superior/inferior
        img.Height = altoMax;

        // Además, limitar por ANCHO para que no desborde la columna.
        var anchoMax = Unit.FromCentimeter(anchoImagenMaxCm);
        if (anchoMax > colFirma) anchoMax = colFirma - Unit.FromPoint(2); // deja 1pt por lado
        img.Width = anchoMax;
    }
    else
    {
        var placeholder = pImg.AddFormattedText("[Firma del Banco]");
        placeholder.Font.Bold = true;
    }

    // Espaciador central
    filaContenido.Cells[1].AddParagraph("");

    // --- DER: texto “Aceptado Digitalmente” ---
    var pTextoDer = filaContenido.Cells[2].AddParagraph("Aceptado Digitalmente");
    pTextoDer.Format.Alignment = ParagraphAlignment.Center;
    pTextoDer.Format.Font.Bold = true;

    // ================= Fila 2: líneas de firma =================
    var filaLinea = tabla.AddRow();
    filaLinea.HeightRule = RowHeightRule.Exactly;
    filaLinea.Height = Unit.FromCentimeter(0.6);
    filaLinea.VerticalAlignment = VerticalAlignment.Bottom;

    filaLinea.Cells[0].Borders.Bottom.Width = 1;
    filaLinea.Cells[0].Borders.Bottom.Color = Colors.Black;

    filaLinea.Cells[1].AddParagraph(""); // espaciador

    filaLinea.Cells[2].Borders.Bottom.Width = 1;
    filaLinea.Cells[2].Borders.Bottom.Color = Colors.Black;

    // ================= Fila 3: etiquetas =================
    var filaEtiquetas = tabla.AddRow();
    filaEtiquetas.HeightRule = RowHeightRule.AtLeast;
    filaEtiquetas.Height = Unit.FromCentimeter(0.8);

    var pBanco = filaEtiquetas.Cells[0].AddParagraph("El Banco");
    pBanco.Format.Alignment = ParagraphAlignment.Center;
    pBanco.Format.Font.Size = 9;

    filaEtiquetas.Cells[1].AddParagraph("");

    var pCliente = filaEtiquetas.Cells[2].AddParagraph("El Cliente");
    pCliente.Format.Alignment = ParagraphAlignment.Center;
    pCliente.Format.Font.Size = 9;
}
