using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Dapper;

public async Task ActualizarEstadoEnvioBatchAsync(
    IEnumerable<(string IdDocumento, int Estado)> items,
    int chunkSize = 200,
    int commandTimeout = 60)
{
    if (items == null)
    {
        _logger.Information("BatchUpdate: items viene null. No se ejecuta nada.");
        return;
    }

    var lista = items
        .Where(x => !string.IsNullOrWhiteSpace(x.IdDocumento))
        .ToList();

    if (lista.Count == 0)
    {
        _logger.Information("BatchUpdate: lista vacía (o IDs vacíos). No se ejecuta nada.");
        return;
    }

    // Si el mismo ID puede repetirse, nos quedamos con el último estado (recomendado)
    var originalCount = lista.Count;
    lista = lista
        .GroupBy(x => x.IdDocumento)
        .Select(g => g.Last())
        .ToList();

    var uniqueCount = lista.Count;

    var now   = DateTime.Now;
    var fecha = now.ToString("yyyyMMdd");
    var hora  = now.ToString("HHmmss");

    if (_database.Connection.State != ConnectionState.Open)
        _database.Connect();

    var totalSw = Stopwatch.StartNew();

    var totalChunks = (int)Math.Ceiling(uniqueCount / (double)chunkSize);
    _logger.Information(
        "BatchUpdate: inicia. Items={OriginalCount}, Unicos={UniqueCount}, ChunkSize={ChunkSize}, Chunks={TotalChunks}, Fecha={Fecha}, Hora={Hora}",
        originalCount, uniqueCount, chunkSize, totalChunks, fecha, hora);

    int totalAffected = 0;
    int chunkIndex = 0;

    try
    {
        for (int offset = 0; offset < uniqueCount; offset += chunkSize)
        {
            chunkIndex++;
            var chunk = lista.Skip(offset).Take(chunkSize).ToList();

            var chunkSw = Stopwatch.StartNew();

            // (?, ?), (?, ?), ...
            var valuesSql = string.Join(",\n", chunk.Select(_ => "(?, ?)"));

            var sql = $@"
MERGE INTO EVERTECDTA.GCTDC09L1 AS T
USING (VALUES
{valuesSql}
) AS S (ID, ESTADO)
ON T.GCTDC09001 = S.ID
WHEN MATCHED THEN
  UPDATE SET
    T.GCTDC09014 = S.ESTADO,
    T.GCTDC09007 = ?,
    T.GCTDC09008 = ?;
";

            // OleDb: parámetros por ORDEN. Dapper: nombres únicos por seguridad.
            var p = new DynamicParameters();
            for (int i = 0; i < chunk.Count; i++)
            {
                p.Add($"id{i}", chunk[i].IdDocumento);
                p.Add($"st{i}", chunk[i].Estado);
            }
            p.Add("fecha", fecha);
            p.Add("hora", hora);

            int affected;
            try
            {
                affected = await _database.Connection.ExecuteAsync(sql, p, commandTimeout: commandTimeout);
            }
            catch (Exception exChunk)
            {
                chunkSw.Stop();
                _logger.Information(
                    "BatchUpdate: ERROR en chunk {ChunkIndex}/{TotalChunks}. RegistrosChunk={ChunkCount}. Ms={ElapsedMs}. Error={Error}",
                    chunkIndex, totalChunks, chunk.Count, chunkSw.ElapsedMilliseconds, exChunk.Message);
                throw; // re-lanzamos para que el caller decida qué hacer
            }

            chunkSw.Stop();
            totalAffected += affected;

            _logger.Information(
                "BatchUpdate: chunk {ChunkIndex}/{TotalChunks} OK. RegistrosChunk={ChunkCount}. FilasAfectadas={Affected}. Ms={ElapsedMs}",
                chunkIndex, totalChunks, chunk.Count, affected, chunkSw.ElapsedMilliseconds);
        }

        totalSw.Stop();
        _logger.Information(
            "BatchUpdate: finaliza OK. Unicos={UniqueCount}. TotalFilasAfectadas={TotalAffected}. TotalMs={TotalMs}",
            uniqueCount, totalAffected, totalSw.ElapsedMilliseconds);
    }
    catch (Exception ex)
    {
        totalSw.Stop();
        _logger.Information(
            "BatchUpdate: finaliza con ERROR. Unicos={UniqueCount}. TotalFilasAfectadasAcum={TotalAffected}. TotalMs={TotalMs}. Error={Error}",
            uniqueCount, totalAffected, totalSw.ElapsedMilliseconds, ex.Message);
        throw;
    }
}
