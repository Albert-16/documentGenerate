¬°Ah! Ahora s√≠ veo el panorama completo en PRODUCCI√ìN. Esto cambia todo:
üìä Situaci√≥n REAL en Producci√≥n:
Ambos states tienen datos:
9641077E-76F4-4FC9-8337-A6AD8FD807D8 (m√°s antiguo, 2025-01-29) ‚Üí 1 registro en state_entities
C2AF7ABE-EBD1-4471-B7BB-3FE9DF44AFFE (m√°s reciente, 2025-09-16) ‚Üí 1 registro en state_entities
Total: 2 registros que necesitan consolidarse.
üéØ Estrategia actualizada:
Deber√≠amos mantener el m√°s ANTIGUO (9641077E...) porque:
Fue el primero en crearse (2025-01-29)
Representa el state "original"
Menos riesgo de romper referencias hist√≥ricas
üìù Script de migraci√≥n ACTUALIZADO:
Reemplaza tu migraci√≥n con este script corregido:
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ManageAdmin.Migrations.Data
{
    public partial class RemoveDuplicateState : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            // IDs identificados en producci√≥n
            var stateToKeep = "9641077E-76F4-4FC9-8337-A6AD8FD807D8";    // M√°s antiguo (MANTENER)
            var stateToRemove = "C2AF7ABE-EBD1-4471-B7BB-3FE9DF44AFFE";  // M√°s reciente (ELIMINAR)

            // 1. Verificar que ambos registros existen
            // ============================================================
            migrationBuilder.Sql($@"
                IF NOT EXISTS (SELECT 1 FROM dbo.states WHERE state_id = '{stateToKeep}')
                BEGIN
                    RAISERROR('ERROR: El state a mantener (m√°s antiguo) no existe en la BD', 16, 1);
                    RETURN;
                END

                IF NOT EXISTS (SELECT 1 FROM dbo.states WHERE state_id = '{stateToRemove}')
                BEGIN
                    PRINT 'AVISO: El state duplicado (m√°s reciente) ya no existe. Migraci√≥n omitida.';
                    RETURN;
                END
                
                PRINT '========================================';
                PRINT 'Iniciando consolidaci√≥n de estados duplicados';
                PRINT 'State a mantener (antiguo): {stateToKeep}';
                PRINT 'State a eliminar (reciente): {stateToRemove}';
                PRINT '========================================';
            ");

            // 2. Contar registros antes de la migraci√≥n
            // ============================================================
            migrationBuilder.Sql($@"
                DECLARE @CountOld INT = (SELECT COUNT(*) FROM dbo.state_entities WHERE state_id = '{stateToKeep}');
                DECLARE @CountNew INT = (SELECT COUNT(*) FROM dbo.state_entities WHERE state_id = '{stateToRemove}');
                
                PRINT 'Registros en state_entities ANTES de migraci√≥n:';
                PRINT '  - State antiguo (mantener): ' + CAST(@CountOld AS VARCHAR(10));
                PRINT '  - State reciente (eliminar): ' + CAST(@CountNew AS VARCHAR(10));
                PRINT '  - Total: ' + CAST((@CountOld + @CountNew) AS VARCHAR(10));
            ");

            // 3. Migrar registros de state_entities del nuevo al antiguo
            // ============================================================
            migrationBuilder.Sql($@"
                -- Migrar todos los registros del state reciente al antiguo
                UPDATE dbo.state_entities 
                SET state_id = '{stateToKeep}'
                WHERE state_id = '{stateToRemove}';
                
                PRINT 'Registros migrados desde state reciente: ' + CAST(@@ROWCOUNT AS VARCHAR(10));
                
                -- Verificar total despu√©s de la migraci√≥n
                DECLARE @TotalAfter INT = (SELECT COUNT(*) FROM dbo.state_entities WHERE state_id = '{stateToKeep}');
                PRINT 'Total de registros en state antiguo despu√©s de migraci√≥n: ' + CAST(@TotalAfter AS VARCHAR(10));
            ");

            // 4. Verificar que no quedan referencias al state reciente
            // ============================================================
            migrationBuilder.Sql($@"
                IF EXISTS (SELECT 1 FROM dbo.state_entities WHERE state_id = '{stateToRemove}')
                BEGIN
                    RAISERROR('ERROR: A√∫n existen referencias en state_entities al state que se intenta eliminar', 16, 1);
                    RETURN;
                END
                
                PRINT 'Verificaci√≥n OK: No quedan referencias al state reciente';
            ");

            // 5. Eliminar el registro duplicado (m√°s reciente)
            // ============================================================
            migrationBuilder.Sql($@"
                DELETE FROM dbo.states 
                WHERE state_id = '{stateToRemove}';
                
                IF @@ROWCOUNT = 1
                BEGIN
                    PRINT 'Estado duplicado eliminado correctamente';
                END
                ELSE
                BEGIN
                    RAISERROR('ERROR: No se pudo eliminar el state duplicado', 16, 1);
                    RETURN;
                END
            ");

            // 6. Crear √≠ndice √∫nico para prevenir duplicados futuros
            // ============================================================
            migrationBuilder.CreateIndex(
                name: "IX_States_StateName_Unique",
                table: "states",
                column: "state_name",
                unique: true);
            
            migrationBuilder.Sql($@"
                PRINT '========================================';
                PRINT 'Consolidaci√≥n completada exitosamente';
                PRINT '√çndice √∫nico creado: IX_States_StateName_Unique';
                PRINT 'Estado mantenido: {stateToKeep} (2025-01-29)';
                PRINT 'Estado eliminado: {stateToRemove} (2025-09-16)';
                PRINT 'Total de state_entities consolidados: 2';
                PRINT '========================================';
            ");
        }

        protected override void Down(MigrationBuilder migrationBuilder)
        {
            // Rollback: eliminar el √≠ndice √∫nico
            migrationBuilder.DropIndex(
                name: "IX_States_StateName_Unique",
                table: "states");
            
            migrationBuilder.Sql(@"
                PRINT 'Rollback ejecutado: √çndice √∫nico eliminado';
                PRINT 'ADVERTENCIA: Los datos consolidados NO se pueden deshacer autom√°ticamente';
                PRINT 'Es necesario restaurar desde backup si se requiere revertir la consolidaci√≥n';
            ");
        }
    }
}
üîç Validaci√≥n adicional ANTES de aplicar:
Ejecuta esto en producci√≥n para confirmar los datos:
USE control_inventario_ti;
GO

-- Ver los registros actuales en cada state
SELECT 
    s.state_id,
    s.state_name,
    s.create_at,
    COUNT(se.id) as total_entities  -- Ajusta 'id' seg√∫n el nombre real de la PK
FROM dbo.states s
LEFT JOIN dbo.state_entities se ON s.state_id = se.state_id
WHERE s.state_name = 'Certificaci√≥n'
GROUP BY s.state_id, s.state_name, s.create_at
ORDER BY s.create_at;
GO

-- Ver detalles de los registros en state_entities
SELECT 
    se.*,
    s.state_name
FROM dbo.state_entities se
INNER JOIN dbo.states s ON se.state_id = s.state_id
WHERE s.state_name = 'Certificaci√≥n'
ORDER BY se.state_id;
GO
üìã Plan de ejecuci√≥n actualizado:
1. En DESARROLLO (prueba primero aqu√≠):
Si tu desarrollo no tiene datos, sim√∫lalos:
-- Solo si necesitas simular el escenario en desarrollo
USE control_inventario_ti;
GO

-- Insertar un registro dummy en cada state
INSERT INTO dbo.state_entities (state_id, /* otras columnas */)
VALUES 
    ('9641077E-76F4-4FC9-8337-A6AD8FD807D8', /* valores */),
    ('C2AF7ABE-EBD1-4471-B7BB-3FE9DF44AFFE', /* valores */);
Luego aplica la migraci√≥n:
Update-Database
2. En PRODUCCI√ìN:
A. Backup (OBLIGATORIO):
USE master;
GO

BACKUP DATABASE control_inventario_ti 
TO DISK = 'C:\Backups\control_inventario_ti_PreConsolidacion_$(Get-Date -Format ''yyyyMMdd_HHmmss'').bak'
WITH COMPRESSION, INIT, 
     NAME = 'Backup antes de consolidar Certificaci√≥n duplicada',
     DESCRIPTION = 'Backup con 2 registros en state_entities antes de consolidaci√≥n';
GO
B. Generar script SQL para revisi√≥n:
dotnet ef migrations script --project ManageAdmin.Migrations --idempotent --output consolidacion_certificacion.sql
C. Aplicar migraci√≥n:
Update-Database
D. Validar resultado:
USE control_inventario_ti;
GO

-- 1. Verificar que solo queda UN state de Certificaci√≥n
SELECT state_id, state_name, create_at, modify_at
FROM dbo.states
WHERE state_name = 'Certificaci√≥n';
-- Debe retornar SOLO: 9641077E-76F4-4FC9-8337-A6AD8FD807D8

-- 2. Verificar que todos los registros est√°n consolidados
SELECT state_id, COUNT(*) AS total
FROM dbo.state_entities
WHERE state_id = '9641077E-76F4-4FC9-8337-A6AD8FD807D8'
GROUP BY state_id;
-- Debe retornar: 2 registros (consolidados)

-- 3. Verificar que no hay hu√©rfanos
SELECT COUNT(*) AS huerfanos
FROM dbo.state_entities
WHERE state_id = 'C2AF7ABE-EBD1-4471-B7BB-3FE9DF44AFFE';
-- Debe retornar: 0

-- 4. Verificar √≠ndice √∫nico
SELECT i.name, i.is_unique
FROM sys.indexes i
WHERE i.object_id = OBJECT_ID('dbo.states')
  AND i.name = 'IX_States_StateName_Unique';
-- Debe retornar: IX_States_StateName_Unique, is_unique = 1

PRINT 'Validaci√≥n completada: Todo correcto ‚úì';
üéØ Resumen de lo que har√° el script:
‚úÖ Verifica que ambos states existen
‚úÖ Cuenta los registros en cada state (1 + 1 = 2 total)
‚úÖ Migra el registro del state reciente al antiguo
‚úÖ Verifica que el state antiguo ahora tiene 2 registros
‚úÖ Elimina el state reciente (vac√≠o despu√©s de la migraci√≥n)
‚úÖ Crea √≠ndice √∫nico para prevenir futuros duplicados
‚úÖ Registra todo el proceso con PRINT statements
¬øListo para aplicarlo? Te recomiendo:
‚úÖ Probar en desarrollo primero
‚úÖ Hacer backup de producci√≥n
‚úÖ Aplicar en horario de bajo tr√°fico
‚úÖ Validar con los queries que te di
