using System;
using System.IO;
using HiQPdf.NetCore;

namespace Infrastructure.Helpers.PdfConverters
{
    public class HiqDocxToPdfConverter
    {
        private readonly string _licenseKey;

        public HiqDocxToPdfConverter(string licenseKey)
        {
            if (string.IsNullOrWhiteSpace(licenseKey))
                throw new ArgumentException("La clave de licencia de HiQPdf no puede ser nula o vacía.", nameof(licenseKey));

            _licenseKey = licenseKey;
            HiQPdf.NetCore.License.SetLicenseKey(_licenseKey);
        }

        /// <summary>
        /// Convierte un archivo DOCX en PDF y lo guarda en disco.
        /// </summary>
        public void ConvertDocxToPdf(string inputDocxPath, string outputPdfPath)
        {
            if (!File.Exists(inputDocxPath))
                throw new FileNotFoundException("No se encontró el archivo DOCX.", inputDocxPath);

            try
            {
                var converter = new HiQPdf.NetCore.DocxToPdf();
                var pdfBytes = converter.ConvertToPdf(File.ReadAllBytes(inputDocxPath));

                File.WriteAllBytes(outputPdfPath, pdfBytes);
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException($"Error al convertir DOCX a PDF: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// Convierte un archivo DOCX a PDF y devuelve el resultado como arreglo de bytes.
        /// Ideal para APIs o almacenamiento temporal.
        /// </summary>
        public byte[] ConvertDocxToPdf(byte[] docxBytes)
        {
            if (docxBytes == null || docxBytes.Length == 0)
                throw new ArgumentException("El contenido DOCX está vacío.");

            try
            {
                var converter = new HiQPdf.NetCore.DocxToPdf();
                return converter.ConvertToPdf(docxBytes);
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException($"Error al convertir DOCX a PDF: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// Convierte un DOCX a PDF y devuelve un stream listo para enviar en un endpoint.
        /// </summary>
        public MemoryStream ConvertDocxToPdfStream(byte[] docxBytes)
        {
            var pdfBytes = ConvertDocxToPdf(docxBytes);
            return new MemoryStream(pdfBytes);
        }
    }
}
